<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Chat Portal</title>
    <style>
        /* Add some styling for better visibility */
        body {
            font-family: Arial, sans-serif;
            margin: 0; /* Remove default margin to ensure full screen usage */
            padding: 0; /* Remove default padding */
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: space-between;
            overflow: hidden; 
        }

        #chat-box {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            box-sizing: content-box;
            max-height: calc(100vh - 50px); /* Adjust max height to leave space for the form and button */
        }

        #message-form {
            display: flex;
            padding: 10px;
            box-sizing: content-box;
        }

        #message-form input,
        #message-form button {
            margin-right: 10px;
        }
        
        #message-form input {
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-box">
            {% for message in messages %}
                <p><strong>{{ message.username }}:</strong> {{ message.message }}</p>
            {% endfor %}
        </div>
        <form id="message-form">
            <label for="message">Message:</label>
            <input type="text" id="message" name="message" placeholder="Message" maxlength="100" required>
            <button type="button" onclick="sendMessage()">Send</button>
        </form>

        <!-- Add the delete button -->
        <button id="delete-button" onclick="deleteChats()">Clear Chats</button>
    </div>

    
    <!-- Add the getCookie and setCookie functions -->
    <script>
        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }

        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
        }

        // Check if the username is stored in a cookie
        let storedUsername = getCookie('username');

        // If username is not found in the cookie or user rejects the prompt, set to "Anonymous"
        if (!storedUsername) {
            storedUsername = prompt('Please enter your username (limit: 20 characters):', 'Anonymous');

            // Apply input validation for the username
            if (storedUsername === null || storedUsername.trim() === '' || storedUsername.length > 20) {
                storedUsername = 'Anonymous';
            }

            // Store the username in a cookie
            setCookie('username', storedUsername, 365);  // Expires in 365 days
        }

        function sendMessage() {
            var message = document.getElementById('message').value;

            if (message) {               
                fetch('/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'username': storedUsername,
                        'message': message,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('message-form').reset();
                        // Optionally, update the chat box without refreshing the page
                        updateChatBox();
                    }
                });
            }
        }

        function deleteChats() {
            // Ask for the password before deleting chats
            const password = prompt('Enter password to delete chats:');
            
            // Perform server-side validation of the password
            if (password) {
                fetch('/delete-chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'password': password,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Chats deleted successfully
                        updateChatBox();
                    } else {
                        alert('Invalid password. Chats not deleted.');
                    }
                });
            }
        }
        
        function updateChatBox() {
            fetch('/')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('chat-box').innerHTML = new DOMParser().parseFromString(html, 'text/html').getElementById('chat-box').innerHTML;
                });
        }

        // Optionally, set up periodic updates (e.g., every 3 seconds)
        setInterval(updateChatBox, 3000);
    </script>
</body>
</html>
